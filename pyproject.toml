[project]
name = "circulus"
dynamic = ["version"]
description = "Differentiable circuit simulator based on JAX"
authors = [
    { name = "Chris Daunt", email = "chris.ll.m.daunt@gmail.com" }
]
readme = "ReadMe.md"
license = { text = "Apache-2.0" }
requires-python = ">=3.11"
keywords = ["jax", "differentiable", "circuit", "simulation", "photonics"]
classifiers = [
    "Development Status :: 3 - Alpha",
    "Intended Audience :: Science/Research",
    "License :: OSI Approved :: Apache Software License",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
]
dependencies = [
    "numpy",
    "jax>=0.7.1,<0.8",
    "jaxlib>=0.7.1,<0.8",
    "diffrax>=0.7.0,<0.8",
    "sax>=0.15.15,<0.16",
    "matplotlib",
    "typing-extensions>=4.13.2",
    "lineax",
    "klujax>=0.4.8"
]

[project.optional-dependencies]
test = [
    "pytest>=8",
    "papermill",
    "ipykernel>=6.29.5",   # required by papermill to execute notebooks
]
docs = [
    "ipykernel>=6.29.5",
    "hippogriffe==0.2.2",
    "mkdocs==1.6.1",
    "mkdocs-include-exclude-files==0.1.0",
    "mkdocs-jupyter",
    "mkdocs-material==9.6.7",
    "mkdocstrings==0.28.3",
    "mkdocstrings-python==1.16.8",
    "mkdocs-gen-files",
    "mkdocs-literate-nav",
    "pymdown-extensions",
    "schemdraw",
    "mkdocs_matplotlib",
    "mkautodoc>=0.2.0",
    "mkdocs-autorefs>=1.3.0",
    "mkdocs-bibtex>=4.4.0",
    "mkdocs-material>=9.6.0",
    "mkdocs>=1.6.1",
    "mkdocstrings[python]>=0.27.0",
]
dev = [
    "circulus[test,docs]",
    "black",
    "ruff",
    "mypy",
    "pre-commit",
]

[project.urls]
Homepage = "https://github.com/cdaunt/circulus"
Repository = "https://github.com/cdaunt/circulus"
Documentation = "https://cdaunt.github.io/circulus"
Issues = "https://github.com/cdaunt/circulus/issues"

# ---------------------------------------------------------------------------
# Build system (PyPI / hatch)
# ---------------------------------------------------------------------------

[build-system]
requires = ["hatchling", "hatch-vcs"]
build-backend = "hatchling.build"

[tool.hatch.version]
source = "vcs"

[tool.hatch.build.hooks.vcs]
version-file = "circulus/_version.py"

[tool.hatch.build.targets.wheel]
packages = ["circulus"]

# ---------------------------------------------------------------------------
# Pixi workspace
# ---------------------------------------------------------------------------

[tool.pixi.workspace]
channels = ["conda-forge"]
platforms = ["linux-64", "win-64", "osx-arm64"]
# pixi-build is still preview-gated
preview = ["pixi-build"]

# Shared editable install for all environments
[tool.pixi.pypi-dependencies]
circulus = { path = ".", editable = true }

# ---------------------------------------------------------------------------
# Conda package build (pixi build)
# pixi-build-python reads [project] metadata directly — no recipe.yaml needed.
# ---------------------------------------------------------------------------

[tool.pixi.package]
name = "circulus"

[tool.pixi.package.build]
backend = { name = "pixi-build-python", version = "*" }

# ---------------------------------------------------------------------------
# Features — one per Python version
# ---------------------------------------------------------------------------

[tool.pixi.feature.py311.dependencies]
python = "3.11.*"

[tool.pixi.feature.py312.dependencies]
python = "3.12.*"

[tool.pixi.feature.py313.dependencies]
python = "3.13.*"
tqdm = ">=4.67.1,<5"

# Test feature — used by CI environments
[tool.pixi.feature.test.pypi-dependencies]
circulus = { path = ".", editable = true, extras = ["test"] }

# Dev tooling feature
[tool.pixi.feature.dev.dependencies]
tqdm = ">=4.67.1,<5"
uv = ">=0.6"


# ---------------------------------------------------------------------------
# Tasks
# ---------------------------------------------------------------------------

[tool.pixi.tasks]
copy_readme      = "cp ReadMe.md docs/index.md && sed -i 's|docs/images|images|g' docs/index.md"
clean_old_docs   = "rm -rf docs/examples/*.ipynb || true"
copy-examples    = { cmd = ["mkdir", "-p", "docs/examples", "&&", "cp", "-r", "examples/*", "docs/examples/"], depends-on = ["clean_old_docs"] }
install_ipkernel = "python -m ipykernel install --user --name circulus"
docs-serve       = { cmd = ["mkdocs", "serve", "-w", "docs"], depends-on = ["copy_readme", "copy-examples", "install_ipkernel"] }
pytest_run       = { cmd = ["pytest", "tests",], depends-on = ["install_ipkernel"] }
lint_format      = "ruff format"
lint_check       = "ruff -v check"
build            = { cmd = "uv build", description = "Build sdist and wheel into dist/" }
build-wheel      = { cmd = "uv build --wheel", description = "Build wheel only" }
build-sdist      = { cmd = "uv build --sdist", description = "Build sdist only" }
build-conda      = { cmd = "pixi build", description = "Build conda package" }
clean-dist       = { cmd = "rm -rf dist/", description = "Remove build artifacts" }

# ---------------------------------------------------------------------------
# Environments
# ---------------------------------------------------------------------------

[tool.pixi.environments]
default = { features = ["py313", "dev"], solve-group = "py313" }

# CI matrix — minimal, no dev extras
py311 = { features = ["py311", "test"], solve-group = "py311" }
py312 = { features = ["py312", "test"], solve-group = "py312" }
py313 = { features = ["py313", "test"], solve-group = "py313" }

# ---------------------------------------------------------------------------
# Pytest
# ---------------------------------------------------------------------------

[tool.pytest.ini_options]
filterwarnings = [
    "ignore::numpy.exceptions.ComplexWarning",
    "ignore:Complex dtype support in Diffrax:UserWarning",
    "ignore:datetime.datetime.utcnow\\(\\) is deprecated:DeprecationWarning:papermill",
]

# ---------------------------------------------------------------------------
# Ruff
# ---------------------------------------------------------------------------

[tool.ruff]
fix = true
target-version = "py311"
line-length = 132

[tool.ruff.format]
docstring-code-format = true

[tool.ruff.lint]  # see https://docs.astral.sh/ruff/rules
ignore = [
    "COM812",   # missing-trailing-comma
    "D401",     # imperative-mood
    "D105",     # undocumented-magic-method
    "D203",     # incorrect-blank-line-before-class
    "D213",     # multi-line-summary-second-line
    "E741",     # ambiguous-variable-name
    "ERA001",   # commented-out-code
    "FIX001",   # line-contains-fixme
    "FIX002",   # line-contains-todo
    "FIX004",   # line-contains-hack
    "N803",     # invalid-argument-name
    "N806",     # non-lowercase-variable-in-function
    "PD901",    # pandas-df-variable-name
    "PLC0414",  # useless-import-alias
    "PLC0415",  # import-outside-top-level
    "PLR0913",  # too-many-arguments
    "PLR2004",  # magic-value-comparison
    "PLW2901",  # redefined-loop-name
    "RET504",   # unnecessary-assign
    "RUF002",   # ambiguous-unicode-character-docstring
    "S324",     # hashlib-insecure-hash-function
    "TC001",    # typing-only-first-party-import
    "TC002",    # typing-only-third-party-import
    "TC003",    # typing-only-standard-library-import
    "TC006",    # runtime-cast-value
    "TD001",    # invalid-todo-tag
    "TD002",    # missing-todo-author
    "TD003",    # missing-todo-link
    "TID252",   # relative-imports
    "TRY003",   # raise-vanilla-args
    "UP013",    # convert-typed-dict-functional-to-class
    "ANN401",
]
select = ["ALL"]

[tool.ruff.lint.per-file-ignores]
"*.ipynb" = [
    "ANN",      # flake8-annotations
    "ARG001",   # unused-function-argument
    "D",        # pydocstyle
    "E402",     # module-import-not-at-top-of-file
    "E501",     # line-too-long
    "F821",     # undefined-name
    "FBT003",   # boolean-positional-value-in-call
    "N816",     # mixed-case-variable-in-global-scope
    "PLC2401",  # non-ascii-name
    "S101",     # assert
    "SLF001",   # private-member-access
    "T201",     # print
]
"docs/hooks.py" = [
    "INP001",   # implicit-namespace-package
    "ARG001",   # unused-function-argument
    "ANN401",   # any-type
    "FBT001",   # boolean-type-hint-positional-argument
]
"tests/*" = [
    "D",        # pydocstyle
    "INP001",   # implicit-namespace-package
    "PT011",    # pytest-raises-too-broad
    "S101",     # assert
    "T201",     # print
]
"circulus/components/*.py" = [
    "N802",
    "ARG001",
]
